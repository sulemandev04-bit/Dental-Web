<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Consultation | BrightSmile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-50 font-sans antialiased">

    <nav class="fixed w-full z-50 bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600 tracking-tight">
                <i class="fa-solid fa-tooth mr-2"></i>BRIGHTSMILE
            </a>
            <a href="index.html" class="text-gray-600 hover:text-blue-600 font-medium transition">
                <i class="fa-solid fa-xmark mr-1"></i> Cancel
            </a>
        </div>
    </nav>

    <main class="pt-32 pb-20 px-4">
        <div class="max-w-4xl mx-auto">
            
            <div class="text-center mb-12">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-4">Book Your Consultation</h1>
                <p class="text-gray-600">Please fill in the details below to schedule your visit with our specialists.</p>
            </div>

            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 overflow-hidden">
                <div class="grid md:grid-cols-3">
                    
                    <div class="bg-blue-600 p-8 md:p-12 text-white">
                        <h3 class="text-xl font-bold mb-8">Why Book Online?</h3>
                        <ul class="space-y-6">
                            <li class="flex items-start">
                                <i class="fa-solid fa-circle-check mt-1 mr-3 text-blue-200"></i>
                                <span>Instant confirmation via email</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa-solid fa-circle-check mt-1 mr-3 text-blue-200"></i>
                                <span>Choose your preferred doctor</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa-solid fa-circle-check mt-1 mr-3 text-blue-200"></i>
                                <span>Free reminder 24h before</span>
                            </li>
                        </ul>
                        <div class="mt-20 pt-8 border-t border-blue-500">
                            <p class="text-sm text-blue-100">Need help?</p>
                            <p class="font-bold">+1 (555) 000-1234</p>
                        </div>
                    </div>

                    <div class="md:col-span-2 p-8 md:p-12">
                        <form id="appointmentForm" class="space-y-6">
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Select Service</label>
                                <select id="servic" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                                    <option value="">Choose a treatment...</option>
                                    <option>General Checkup</option>
                                    <option>Teeth Whitening</option>
                                    <option>Dental Braces</option>
                                    <option>Root Canal</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Choose Doctor</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="cursor-pointer">
                                        <input type="radio"  name="doctor" value="Dr.Sarah" class="hidden peer" required>
                                        <div class="p-3 border rounded-xl text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-slate-50 transition">
                                            <p class="font-bold text-sm">Dr. Sarah</p>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="doctor" value="Dr. Michael" class="hidden peer">
                                        <div class="p-3 border rounded-xl text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-slate-50 transition">
                                            <p class="font-bold text-sm">Dr. Michael</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Date</label>
                                    <input type="date" id="date" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Preferred Time</label>
                                    <select id="time" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                                        <option>09:00 AM</option>
                                        <option>11:00 AM</option>
                                        <option>02:00 PM</option>
                                        <option>04:00 PM</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Any special notes?</label>
                                <textarea id="message" placeholder="Tell us about your concern..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition" rows="3"></textarea>
                            </div>

                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all flex items-center justify-center">
                                Confirm Appointment <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script type="module">

        import { db, ref, get, push, set, } from "./firebaseConfig.js";

        const appointmentform = document.getElementById('appointmentForm');

        if (appointmentform) {
            appointmentform.addEventListener('submit', async (e) => {
                e.preventDefault();

                const form = e.currentTarget; 
                const btn = form.querySelector('button');
                btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin mr-2"></i> Checking availability...';
                btn.disable = true;


                // 1. Capture user input
               const selectedDoctor = document.querySelector('input[name="doctor"]:checked')?.value;
                const servic = document.getElementById('servic').value;
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const message = document.getElementById('message').value;
                
                // 2. Reference the 'appointments' node
                const appointmentsRef = ref(db, 'appointments');

                try {
                    // 3. CHECK FOR CONFLICTS
                    // We search for appointments that match the user's selected date
                    const snapshot = await get(appointmentsRef);
                    let isTaken = false;

                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        // Loop through existing appointments to see if date and time match
                        for (let id in data) {
                            if (data[id].appointmentDate === date && data[id].appointmentTime === time) {
                                isTaken = true;
                                break;
                            }
                        }
                    }

                    // 4. LOGIC BRANCHING
                    if (isTaken) {
                        alert("Sorry, this time slot is already booked. Please choose another time.");
                        btn.innerHTML = '<i class="fa-solid fa-circle-exclamation mr-2"></i> Slot Taken - Try Again';
                        btn.disable = true
                    } else {
                        // No conflict found, proceed with booking
                        const newAppointmentRef = push(appointmentsRef);
                        await set(newAppointmentRef, {
                            Servic: servic,
                            DoctorName: selectedDoctor,
                            appointmentDate: date,
                            appointmentTime: time,
                            status: "booked",
                            Message: message
                        });

                        alert("Appointment confirmed!");
                        appointmentForm.reset();
                        btn.innerHTML = '<i class="fa-solid fa-circle-check mr-2"></i> Appointment Booked!';
                        btn.disable = true;
                    }

                } catch (error) {
                    console.error("Error:", error);
                    alert("Something went wrong. Please try again.");
                    btn.innerHTML = originalBtnText;
                    
                }
            });
        }

    </script>
</body>
</html>